<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Digital - Liceo Cuna de Fabini</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .screen {
            display: none;
            padding: 30px;
            min-height: 500px;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome-content {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .team-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 25px auto;
            max-width: 600px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--secondary);
            outline: none;
        }
        
        .skill-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        
        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: var(--secondary);
        }
        
        .skill-card.completed {
            background: var(--success);
            color: white;
        }
        
        .skill-card.locked {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .skill-card.incomplete {
            background: #fff3cd;
            border-color: var(--warning);
        }
        
        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .skill-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .skill-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            background: var(--light);
            color: var(--dark);
        }
        
        .skill-status.completed {
            background: white;
            color: var(--success);
        }
        
        .skill-status.incomplete {
            background: var(--warning);
            color: white;
        }
        
        .challenge-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .challenge-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .difficulty {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .difficulty.facil {
            background: var(--success);
            color: white;
        }
        
        .difficulty.medio {
            background: var(--warning);
            color: white;
        }
        
        .difficulty.dificil {
            background: var(--accent);
            color: white;
        }
        
        .challenge-content {
            margin-bottom: 25px;
        }
        
        .options-container {
            display: grid;
            gap: 15px;
            margin: 25px 0;
        }
        
        .option {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            background: #e9ecef;
            border-color: var(--secondary);
        }
        
        .option.selected {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .attempts-counter {
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            color: var(--dark);
        }
        
        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .secret-word-reveal {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            display: none;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .timer-container {
            background: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #timer {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--light);
            margin: 10px 0;
        }
        
        .challenge-timer {
            background: var(--warning);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .progress-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .progress-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            margin: 0 5px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .progress-item.active {
            background: var(--secondary);
            color: white;
        }
        
        .progress-item.completed {
            background: var(--success);
            color: white;
        }
        
        .progress-item.incomplete {
            background: var(--warning);
            color: white;
        }
        
        .final-results {
            text-align: center;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .final-phrase {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 25px auto;
            font-size: 1.5rem;
            font-weight: bold;
            max-width: 800px;
            text-align: center;
        }
        
        .luminous-message {
            background: linear-gradient(45deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #8B00FF);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite, glow 2s ease-in-out infinite alternate;
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 25px auto;
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
            border: 3px solid white;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(255,255,255,0.5); }
            to { box-shadow: 0 0 30px rgba(255,255,255,0.8), 0 0 40px rgba(255,255,255,0.6); }
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .results-table th, .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .results-table th {
            background: var(--primary);
            color: white;
        }
        
        .skill-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e0e0e0;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .hidden {
            display: none;
        }
        
        .team-info-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        /* Estilos para gr√°ficos */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .charts-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .chart-wrapper {
            flex: 1;
            min-width: 300px;
        }
        
        /* Estilos para barras de logros */
        .achievement-bars {
            margin: 20px 0;
        }
        
        .achievement-bar {
            margin-bottom: 15px;
        }
        
        .achievement-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .achievement-progress {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .achievement-fill {
            height: 100%;
            background: var(--success);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* Estilos para gr√°fica estilo LEGO */
        .lego-chart {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .lego-brick {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin: 2px;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2);
        }
        
        .lego-brick.completed {
            background: #FF6B6B;
        }
        
        .lego-brick.incomplete {
            background: #CCCCCC;
        }
        
        .lego-brick.current {
            background: #4ECDC4;
        }
        
        .lego-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .lego-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .lego-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .time-warning {
            color: #e74c3c !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .completion-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Escape Room Digital</h1>
            </div>
            <p class="subtitle">Liceo Cuna de Fabini - Sol√≠s de Mataojo</p>
            <p class="subtitle">Desaf√≠os de Pensamiento Computacional</p>
        </header>
        
        <!-- Pantalla de Bienvenida -->
        <div id="welcome-screen" class="screen active">
            <div class="welcome-content">
                <h2>¬°Bienvenidos al Escape Room Digital!</h2>
                <p>Demuestra tus habilidades de pensamiento computacional resolviendo desaf√≠os en diferentes √°reas del liceo.</p>
                
                <div class="team-form">
                    <h3>Informaci√≥n del Equipo</h3>
                    <div class="form-group">
                        <label for="team-name">Nombre del Equipo:</label>
                        <input type="text" id="team-name" placeholder="Ingresa el nombre de tu equipo" required>
                    </div>
                    <div class="form-group">
                        <label for="team-members">Integrantes del Equipo (separados por comas):</label>
                        <textarea id="team-members" placeholder="Ej: Juan P√©rez, Mar√≠a Gonz√°lez, Carlos Rodr√≠guez" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="team-grade">Curso:</label>
                        <input type="text" id="team-grade" placeholder="Ej: 1¬∞ A" required>
                    </div>
                    <div class="action-buttons" style="justify-content: center;">
                        <button id="begin-btn" class="btn btn-success">Comenzar Desaf√≠o</button>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>Instrucciones del Juego</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">35</div>
                            <div class="stat-label">minutos totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">6</div>
                            <div class="stat-label">√°reas del liceo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">18</div>
                            <div class="stat-label">desaf√≠os</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">2</div>
                            <div class="stat-label">intentos c/u</div>
                        </div>
                    </div>
                    
                    <ul style="text-align: left; display: inline-block; margin: 15px 0;">
                        <li>Cada desaf√≠o tiene un <strong>tiempo l√≠mite individual</strong></li>
                        <li>Si no superas un desaf√≠o en 2 intentos, <strong>avanzar√°s autom√°ticamente</strong></li>
                        <li>Al completar cada √°rea, recibir√°s una <strong>palabra clave</strong></li>
                        <li>Al final, todas las palabras formar√°n un <strong>mensaje secreto</strong></li>
                        <li>Al terminar, completar√°s un <strong>formulario de evaluaci√≥n</strong></li>
                        <li>Si sobra tiempo, podr√°s <strong>volver a intentar</strong> los desaf√≠os no completados</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Selecci√≥n de √Åreas -->
        <div id="skills-screen" class="screen">
            <div class="timer-container">
                <h3>Tiempo Restante</h3>
                <div id="timer">35:00</div>
            </div>
            
            <div class="team-info-display">
                <strong>Equipo:</strong> <span id="display-team-name"></span> | 
                <strong>Integrantes:</strong> <span id="display-team-members"></span> |
                <strong>Curso:</strong> <span id="display-team-grade"></span>
            </div>
            
            <div class="progress-container">
                <div class="progress-item active" id="progress-cantina">Cantina</div>
                <div class="progress-item" id="progress-adscripcion">Adscripci√≥n</div>
                <div class="progress-item" id="progress-patio">Patio</div>
                <div class="progress-item" id="progress-biblioteca">Biblioteca</div>
                <div class="progress-item" id="progress-informatica">Inform√°tica</div>
                <div class="progress-item" id="progress-laboratorio">Laboratorio</div>
            </div>
            
            <h2>Selecciona un √Årea del Liceo para Comenzar</h2>
            <p>Completa los 3 desaf√≠os de cada √°rea para obtener su palabra clave.</p>
            
            <div id="skills-container">
                <!-- Las tarjetas de √°reas se generar√°n din√°micamente -->
            </div>
            
            <div class="completion-options">
                <button id="force-completion" class="btn btn-warning">Finalizar Ahora y Ver Informe</button>
            </div>
        </div>
        
        <!-- Pantallas de Desaf√≠os por √Årea -->
        <div id="challenges-screen" class="screen">
            <div class="timer-container">
                <h3>Tiempo Restante Total</h3>
                <div id="challenge-timer">35:00</div>
            </div>
            
            <div class="team-info-display">
                <strong>Equipo:</strong> <span id="challenge-team-name"></span> | 
                <strong>Integrantes:</strong> <span id="challenge-team-members"></span> |
                <strong>Curso:</strong> <span id="challenge-team-grade"></span>
            </div>
            
            <div class="progress-container">
                <div class="progress-item active" id="progress-challenge-1">Desaf√≠o 1</div>
                <div class="progress-item" id="progress-challenge-2">Desaf√≠o 2</div>
                <div class="progress-item" id="progress-challenge-3">Desaf√≠o 3</div>
            </div>
            
            <div class="challenge-timer">
                <h3>Tiempo por Desaf√≠o: <span id="individual-timer">05:00</span></h3>
            </div>
            
            <div id="current-skill-header">
                <h2>√Årea: <span id="current-skill-name"></span></h2>
                <p id="current-skill-description"></p>
            </div>
            
            <div id="challenges-container">
                <!-- Los desaf√≠os se insertar√°n aqu√≠ mediante JavaScript -->
            </div>
            
            <div class="action-buttons">
                <button id="back-to-skills" class="btn btn-warning">Volver a √Åreas</button>
            </div>
        </div>
        
        <!-- Pantalla de Finalizaci√≥n -->
        <div id="completion-screen" class="screen">
            <div class="final-results">
                <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                <h2>¬°Escape Room Completado!</h2>
                <p>Tu equipo <strong id="team-result-name"></strong> ha demostrado excelentes habilidades de pensamiento computacional.</p>
                
                <div class="luminous-message" id="final-message">
                    <!-- El mensaje final luminoso se mostrar√° aqu√≠ -->
                </div>
                
                <div class="tabs-container">
                    <div class="tabs">
                        <button class="tab active" data-tab="results">Resultados</button>
                        <button class="tab" data-tab="achievements">Logros</button>
                        <button class="tab" data-tab="lego">Progreso LEGO</button>
                        <button class="tab" data-tab="evaluation">Evaluaci√≥n</button>
                    </div>
                    
                    <div class="tab-content active" id="results-tab">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-correct">0</div>
                                <div class="stat-label">Aciertos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-incorrect">0</div>
                                <div class="stat-label">Fallos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-words">0</div>
                                <div class="stat-label">Palabras</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-time">35:00</div>
                                <div class="stat-label">Tiempo usado</div>
                            </div>
                        </div>
                        
                        <div style="max-width: 800px; margin: 0 auto;">
                            <h3>Resumen de Resultados</h3>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>√Årea del Liceo</th>
                                        <th>Palabra Clave</th>
                                        <th>Aciertos</th>
                                        <th>Fallos</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body">
                                    <!-- Los resultados se llenar√°n din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <h3>Integrantes del Equipo</h3>
                            <p id="team-members-result"></p>
                            <p><strong>Curso:</strong> <span id="team-grade-result"></span></p>
                        </div>
                        
                        <div class="completion-options">
                            <button id="download-report" class="btn btn-primary">Descargar Informe</button>
                            <button id="continue-playing" class="btn btn-success">Continuar Jugando</button>
                            <button id="new-game-btn" class="btn btn-warning">Nuevo Juego</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="achievements-tab">
                        <h3>Barras de Logros</h3>
                        <div class="achievement-bars" id="achievement-bars">
                            <!-- Las barras de logros se generar√°n din√°micamente -->
                        </div>
                        
                        <div class="chart-container">
                            <h3>Progreso por √Årea</h3>
                            <canvas id="skillsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="lego-tab">
                        <h3>Progreso Visual - Estilo LEGO</h3>
                        <p>Cada bloque representa un desaf√≠o completado en el Escape Room</p>
                        
                        <div class="lego-chart" id="lego-chart">
                            <!-- Los bloques LEGO se generar√°n din√°micamente -->
                        </div>
                        
                        <div class="lego-legend">
                            <div class="lego-legend-item">
                                <div class="lego-color" style="background: #FF6B6B;"></div>
                                <span>Desaf√≠os Completados</span>
                            </div>
                            <div class="lego-legend-item">
                                <div class="lego-color" style="background: #4ECDC4;"></div>
                                <span>Desaf√≠os Actuales</span>
                            </div>
                            <div class="lego-legend-item">
                                <div class="lego-color" style="background: #CCCCCC;"></div>
                                <span>Desaf√≠os Pendientes</span>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3>Distribuci√≥n de Resultados</h3>
                            <canvas id="resultsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="evaluation-tab">
                        <form id="evaluation-form" class="evaluation-form">
                            <div class="evaluation-section">
                                <h3>Autoevaluaci√≥n del Equipo</h3>
                                <p>Eval√∫a el desempe√±o de tu equipo durante la actividad (1 = Muy bajo, 5 = Muy alto):</p>
                                
                                <div class="form-group">
                                    <label>Colaboraci√≥n y trabajo en equipo:</label>
                                    <div class="rating-scale">
                                        <div class="rating-option">
                                            <input type="radio" id="collab1" name="collaboration" value="1" required>
                                            <label for="collab1">1</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="collab2" name="collaboration" value="2">
                                            <label for="collab2">2</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="collab3" name="collaboration" value="3">
                                            <label for="collab3">3</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="collab4" name="collaboration" value="4">
                                            <label for="collab4">4</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="collab5" name="collaboration" value="5">
                                            <label for="collab5">5</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Comprensi√≥n de los conceptos:</label>
                                    <div class="rating-scale">
                                        <div class="rating-option">
                                            <input type="radio" id="understanding1" name="understanding" value="1" required>
                                            <label for="understanding1">1</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="understanding2" name="understanding" value="2">
                                            <label for="understanding2">2</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="understanding3" name="understanding" value="3">
                                            <label for="understanding3">3</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="understanding4" name="understanding" value="4">
                                            <label for="understanding4">4</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="understanding5" name="understanding" value="5">
                                            <label for="understanding5">5</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Aplicaci√≥n del pensamiento computacional:</label>
                                    <div class="rating-scale">
                                        <div class="rating-option">
                                            <input type="radio" id="application1" name="application" value="1" required>
                                            <label for="application1">1</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="application2" name="application" value="2">
                                            <label for="application2">2</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="application3" name="application" value="3">
                                            <label for="application3">3</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="application4" name="application" value="4">
                                            <label for="application4">4</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="application5" name="application" value="5">
                                            <label for="application5">5</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="evaluation-section">
                                <h3>Evaluaci√≥n de la Actividad</h3>
                                <p>Valora tu experiencia con el Escape Room (1 = Muy bajo, 5 = Muy alto):</p>
                                
                                <div class="form-group">
                                    <label>Diversi√≥n y motivaci√≥n:</label>
                                    <div class="rating-scale">
                                        <div class="rating-option">
                                            <input type="radio" id="fun1" name="fun" value="1" required>
                                            <label for="fun1">1</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="fun2" name="fun" value="2">
                                            <label for="fun2">2</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="fun3" name="fun" value="3">
                                            <label for="fun3">3</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="fun4" name="fun" value="4">
                                            <label for="fun4">4</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="fun5" name="fun" value="5">
                                            <label for="fun5">5</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Dificultad apropiada:</label>
                                    <div class="rating-scale">
                                        <div class="rating-option">
                                            <input type="radio" id="difficulty1" name="difficulty" value="1" required>
                                            <label for="difficulty1">1</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="difficulty2" name="difficulty" value="2">
                                            <label for="difficulty2">2</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="difficulty3" name="difficulty" value="3">
                                            <label for="difficulty3">3</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="difficulty4" name="difficulty" value="4">
                                            <label for="difficulty4">4</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="difficulty5" name="difficulty" value="5">
                                            <label for="difficulty5">5</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Gesti√≥n del tiempo:</label>
                                    <div class="rating-scale">
                                        <div class="rating-option">
                                            <input type="radio" id="time1" name="time_management" value="1" required>
                                            <label for="time1">1</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="time2" name="time_management" value="2">
                                            <label for="time2">2</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="time3" name="time_management" value="3">
                                            <label for="time3">3</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="time4" name="time_management" value="4">
                                            <label for="time4">4</label>
                                        </div>
                                        <div class="rating-option">
                                            <input type="radio" id="time5" name="time_management" value="5">
                                            <label for="time5">5</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="evaluation-section">
                                <h3>Comentarios Adicionales</h3>
                                <div class="form-group">
                                    <label for="strengths">¬øQu√© fue lo que m√°s te gust√≥ de la actividad?</label>
                                    <textarea id="strengths" rows="3" placeholder="Escribe aqu√≠ tus comentarios..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="improvements">¬øQu√© mejorar√≠as de la actividad?</label>
                                    <textarea id="improvements" rows="3" placeholder="Escribe aqu√≠ tus sugerencias..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="learnings">¬øQu√© aprendiste sobre pensamiento computacional?</label>
                                    <textarea id="learnings" rows="3" placeholder="Escribe aqu√≠ tus aprendizajes..."></textarea>
                                </div>
                            </div>
                            
                            <div class="action-buttons" style="justify-content: center;">
                                <button type="submit" class="btn btn-success">Enviar Evaluaci√≥n</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // DATOS DEL JUEGO - √ÅREAS DEL LICEO CUNA DE FABINI
        // =============================================
        
        const skillsData = [
            {
                id: "cantina",
                name: "Cantina",
                description: "Resuelve problemas relacionados con la organizaci√≥n y gesti√≥n de la cantina escolar",
                icon: "üçΩÔ∏è",
                secretWord: "ORGANIZACI√ìN",
                challenges: [
                    {
                        id: 1,
                        title: "Optimizaci√≥n de Colas en la Cantina",
                        difficulty: "facil",
                        correctAnswer: "B",
                        timeLimit: 5,
                        content: `
                            <p><strong>Contexto:</strong> La cantina del liceo tiene problemas de aglomeraci√≥n durante el recreo. Los estudiantes hacen filas largas y desordenadas.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l ser√≠a la MEJOR estrategia para optimizar el servicio en la cantina?</p>
                        `,
                        options: [
                            "Aumentar el precio de los productos para reducir la demanda",
                            "Implementar un sistema de turnos por cursos y secciones", 
                            "Reducir el tiempo de recreo para que haya menos compradores",
                            "Permitir que los estudiantes compren durante las clases"
                        ]
                    },
                    {
                        id: 2,
                        title: "Gesti√≥n de Inventario de la Cantina",
                        difficulty: "medio",
                        correctAnswer: "C",
                        timeLimit: 4,
                        content: `
                            <p><strong>Contexto:</strong> La cantina frecuentemente se queda sin los productos m√°s populares y tiene exceso de otros que no se venden.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© sistema de gesti√≥n permitir√≠a optimizar mejor el inventario?</p>
                        `,
                        options: [
                            "Comprar la misma cantidad de todos los productos cada semana",
                            "Pedir a los proveedores que decidan qu√© productos enviar", 
                            "Llevar registro de ventas y ajustar pedidos seg√∫n la demanda",
                            "Comprar grandes cantidades al inicio del a√±o lectivo"
                        ]
                    },
                    {
                        id: 3, 
                        title: "Men√∫ Saludable y Sostenible",
                        difficulty: "dificil",
                        correctAnswer: "D",
                        timeLimit: 6,
                        content: `
                            <p><strong>Contexto:</strong> El liceo quiere implementar un men√∫ m√°s saludable y reducir el uso de pl√°sticos desechables.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l ser√≠a el plan M√ÅS efectivo considerando salud, costo y sostenibilidad?</p>
                        `,
                        options: [
                            "Eliminar todos los alimentos procesados de inmediato",
                            "Subir los precios para compensar el costo de opciones saludables", 
                            "Prohibir la venta de bebidas azucaradas sin ofrecer alternativas",
                            "Introducir gradualmente opciones saludables y sistema de envases reutilizables"
                        ]
                    }
                ]
            },
            {
                id: "adscripcion",
                name: "Adscripci√≥n",
                description: "Desarrolla habilidades para la gesti√≥n administrativa y organizaci√≥n escolar",
                icon: "üìã",
                secretWord: "EFICIENCIA",
                challenges: [
                    {
                        id: 1,
                        title: "Sistema de Notificaciones Escolares",
                        difficulty: "facil", 
                        correctAnswer: "A",
                        timeLimit: 5,
                        content: `
                            <p><strong>Contexto:</strong> La adscripci√≥n necesita comunicar informaci√≥n importante a estudiantes, profesores y familias.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© m√©todo de comunicaci√≥n ser√≠a M√ÅS eficiente para diferentes tipos de mensajes?</p>
                        `,
                        options: [
                            "Combinar pizarra digital, correo y app seg√∫n urgencia y destinatario",
                            "Usar solo el cuaderno de comunicaciones para todos los mensajes", 
                            "Publicar toda la informaci√≥n en un mural f√≠sico en la entrada",
                            "Depender exclusivamente del boca a boca entre estudiantes"
                        ]
                    },
                    {
                        id: 2,
                        title: "Organizaci√≥n de Documentaci√≥n Estudiantil",
                        difficulty: "medio",
                        correctAnswer: "C", 
                        timeLimit: 4,
                        content: `
                            <p><strong>Contexto:</strong> La adscripci√≥n maneja documentos de 500 estudiantes: fichas m√©dicas, autorizaciones, boletines.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l es la MEJOR forma de organizar esta informaci√≥n para acceso r√°pido y seguro?</p>
                        `,
                        options: [
                            "Guardar todos los documentos mezclados en cajas grandes",
                            "Tener una carpeta f√≠sica por estudiante sin orden espec√≠fico", 
                            "Sistema digital con carpetas por curso y b√∫squeda por nombre",
                            "Mantener solo copias en papel sin respaldo digital"
                        ]
                    },
                    {
                        id: 3,
                        title: "Optimizaci√≥n de Procesos Administrativos",
                        difficulty: "dificil",
                        correctAnswer: "B",
                        timeLimit: 6,
                        content: `
                            <p><strong>Contexto:</strong> Los tr√°mites de justificaci√≥n de inasistencias toman mucho tiempo y generan colas.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© cambios en el proceso reducir√≠an significativamente los tiempos de espera?</p>
                        `,
                        options: [
                            "Exigir m√°s documentaci√≥n para evitar fraudes",
                            "Implementar sistema online y ventanillas por tipo de tr√°mite", 
                            "Reducir el horario de atenci√≥n al p√∫blico",
                            "Delegar toda la responsabilidad a los preceptores"
                        ]
                    }
                ]
            },
            {
                id: "patio",
                name: "Patio con Mesa de Ping Pong",
                description: "Aplica pensamiento algor√≠tmico en situaciones recreativas y de convivencia",
                icon: "üèì",
                secretWord: "CONVIVENCIA",
                challenges: [
                    {
                        id: 1,
                        title: "Organizaci√≥n de Torneos de Ping Pong",
                        difficulty: "facil",
                        correctAnswer: "D",
                        timeLimit: 5,
                        content: `
                            <p><strong>Contexto:</strong> Quieres organizar un torneo de ping pong con 16 participantes durante los recreos.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l es la estructura M√ÅS justa y eficiente para el torneo?</p>
                        `,
                        options: [
                            "Todos juegan contra todos sin eliminatorias",
                            "Sistema de desaf√≠os donde cualquiera puede retar al campe√≥n", 
                            "Eliminaci√≥n simple sin cabezas de serie",
                            "Eliminaci√≥n simple con cabezas de serie seg√∫n nivel"
                        ]
                    },
                    {
                        id: 2,
                        title: "Gesti√≥n de Turnos en la Mesa de Ping Pong",
                        difficulty: "medio",
                        correctAnswer: "A",
                        timeLimit: 4,
                        content: `
                            <p><strong>Contexto:</strong> Hay mucha demanda para usar la mesa de ping pong durante el recreo y surgen conflictos.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© sistema garantizar√≠a un acceso equitativo?</p>
                        `,
                        options: [
                            "Sistema de turnos por cursos con l√≠mite de tiempo", 
                            "Que los m√°s habilidosos tengan prioridad",
                            "Permitir que los primeros en llegar jueguen todo el recreo",
                            "Prohibir el ping pong durante los recreos m√°s concurridos"
                        ]
                    },
                    {
                        id: 3,
                        title: "Resoluci√≥n de Conflictos en el Patio",
                        difficulty: "dificil",
                        correctAnswer: "C",
                        timeLimit: 6,
                        content: `
                            <p><strong>Contexto:</strong> Surgen disputas sobre las reglas del ping pong y la ocupaci√≥n del espacio.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l es el procedimiento M√ÅS efectivo para resolver conflictos?</p>
                        `,
                        options: [
                            "Imponer sanciones inmediatas sin escuchar a las partes",
                            "Ignorar los conflictos hasta que se resuelvan solos", 
                            "Establecer reglas claras y sistema de mediaci√≥n estudiantil",
                            "Delegar siempre la soluci√≥n a la direcci√≥n del liceo"
                        ]
                    }
                ]
            },
            {
                id: "biblioteca",
                name: "Biblioteca",
                description: "Desarrolla habilidades de b√∫squeda, organizaci√≥n y gesti√≥n de informaci√≥n",
                icon: "üìö",
                secretWord: "INVESTIGACI√ìN",
                challenges: [
                    {
                        id: 1,
                        title: "Sistema de Clasificaci√≥n de Libros",
                        difficulty: "facil",
                        correctAnswer: "B", 
                        timeLimit: 5,
                        content: `
                            <p><strong>Contexto:</strong> La biblioteca tiene libros desorganizados y los estudiantes tienen dificultad para encontrar lo que buscan.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© sistema de organizaci√≥n facilitar√≠a M√ÅS la b√∫squeda?</p>
                        `,
                        options: [
                            "Ordenar los libros por color de portada",
                            "Sistema decimal por materias con etiquetas claras", 
                            "Agrupar por tama√±o de los libros",
                            "Colocar todos los libros en orden alfab√©tico sin importar tema"
                        ]
                    },
                    {
                        id: 2,
                        title: "Pr√©stamo y Devoluci√≥n de Materiales",
                        difficulty: "medio",
                        correctAnswer: "D",
                        timeLimit: 4,
                        content: `
                            <p><strong>Contexto:</strong> Muchos libros no regresan a la biblioteca o llegan con da√±os.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© medidas mejorar√≠an el sistema de pr√©stamos?</p>
                        `,
                        options: [
                            "Prohibir completamente los pr√©stamos a domicilio",
                            "Cobrar multas muy altas por retrasos", 
                            "Limitar los pr√©stamos solo a profesores",
                            "Sistema digital de control, recordatorios y carnet de responsable"
                        ]
                    },
                    {
                        id: 3,
                        title: "Fomento de la Lectura Digital",
                        difficulty: "dificil",
                        correctAnswer: "C",
                        timeLimit: 6,
                        content: `
                            <p><strong>Contexto:</strong> El liceo quiere incorporar recursos digitales a la biblioteca para complementar los libros f√≠sicos.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l ser√≠a la estrategia M√ÅS efectiva?</p>
                        `,
                        options: [
                            "Eliminar todos los libros f√≠sicos y pasar completamente a digital",
                            "Mantener solo el sistema tradicional sin cambios", 
                            "Crear biblioteca h√≠brida con acceso a plataformas digitales y capacitaci√≥n",
                            "Comprar tablets para todos los estudiantes sin contenido espec√≠fico"
                        ]
                    }
                ]
            },
            {
                id: "informatica",
                name: "Sala de Inform√°tica",
                description: "Desarrolla competencias digitales y de programaci√≥n",
                icon: "üíª",
                secretWord: "INNOVACI√ìN",
                challenges: [
                    {
                        id: 1,
                        title: "Mantenimiento de Equipos Inform√°ticos",
                        difficulty: "facil",
                        correctAnswer: "A",
                        timeLimit: 5,
                        content: `
                            <p><strong>Contexto:</strong> Los equipos de la sala de inform√°tica se vuelven lentos con el tiempo y tienen virus.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© medidas preventivas son M√ÅS importantes?</p>
                        `,
                        options: [
                            "Antivirus actualizado, limpieza regular y pol√≠ticas de uso claro", 
                            "Reiniciar los equipos solo cuando fallen completamente",
                            "Permitir que los estudiantes instalen cualquier software",
                            "Usar los equipos sin conexi√≥n a internet para evitar virus"
                        ]
                    },
                    {
                        id: 2,
                        title: "Ense√±anza de Programaci√≥n con Scratch",
                        difficulty: "medio",
                        correctAnswer: "B",
                        timeLimit: 4,
                        content: `
                            <p><strong>Contexto:</strong> Quieres ense√±ar programaci√≥n a estudiantes de primer a√±o usando Scratch.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l es la secuencia de aprendizaje M√ÅS efectiva?</p>
                        `,
                        options: [
                            "Empezar directamente con conceptos avanzados de Python",
                            "Proyectos guiados que progresen en complejidad", 
                            "Teor√≠a pura sobre algoritmos sin pr√°ctica",
                            "Competencias de programaci√≥n desde el primer d√≠a"
                        ]
                    },
                    {
                        id: 3,
                        title: "Rob√≥tica Educativa en el Liceo",
                        difficulty: "dificil",
                        correctAnswer: "C",
                        timeLimit: 6,
                        content: `
                            <p><strong>Contexto:</strong> El liceo quiere implementar un programa de rob√≥tica con recursos limitados.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© estrategia maximizar√≠a el impacto educativo?</p>
                        `,
                        options: [
                            "Comprar robots muy costosos para unos pocos estudiantes",
                            "Enfocarse solo en teor√≠a sin equipos pr√°cticos", 
                            "Kits b√°sicos reutilizables y proyectos colaborativos por grupos",
                            "Esperar a tener financiamiento completo antes de empezar"
                        ]
                    }
                ]
            },
            {
                id: "laboratorio",
                name: "Laboratorio",
                description: "Aplica m√©todo cient√≠fico y pensamiento computacional en experimentaci√≥n",
                icon: "üî¨",
                secretWord: "EXPERIMENTACI√ìN",
                challenges: [
                    {
                        id: 1,
                        title: "Seguridad en el Laboratorio",
                        difficulty: "facil",
                        correctAnswer: "D",
                        timeLimit: 5,
                        content: `
                            <p><strong>Contexto:</strong> Los estudiantes no siempre siguen las normas de seguridad en el laboratorio.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© sistema garantizar√≠a M√ÅS seguridad?</p>
                        `,
                        options: [
                            "Prohibir todos los experimentos considerados riesgosos",
                            "Confiar en que los estudiantes ser√°n responsables sin supervisi√≥n", 
                            "Permitir experimentos libres sin restricciones",
                            "Protocolos claros, equipo de protecci√≥n y supervisi√≥n constante"
                        ]
                    },
                    {
                        id: 2,
                        title: "Metodolog√≠a de Experimentaci√≥n",
                        difficulty: "medio",
                        correctAnswer: "A",
                        timeLimit: 4,
                        content: `
                            <p><strong>Contexto:</strong> Los estudiantes tienen dificultad para dise√±ar experimentos v√°lidos.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øCu√°l es la secuencia CORRECTA del m√©todo cient√≠fico?</p>
                        `,
                        options: [
                            "Observaci√≥n, pregunta, hip√≥tesis, experimentaci√≥n, an√°lisis, conclusi√≥n", 
                            "Experimento, resultado, teor√≠a, observaci√≥n",
                            "Conclusi√≥n, hip√≥tesis, experimentaci√≥n, observaci√≥n",
                            "Hip√≥tesis, conclusi√≥n, experimentaci√≥n, observaci√≥n"
                        ]
                    },
                    {
                        id: 3,
                        title: "An√°lisis de Datos Experimentales",
                        difficulty: "dificil",
                        correctAnswer: "B",
                        timeLimit: 6,
                        content: `
                            <p><strong>Contexto:</strong> Un grupo obtiene resultados inconsistentes en sus experimentos.</p>
                            <p><strong>Desaf√≠o:</strong> ¬øQu√© estrategia ayudar√≠a a identificar y corregir los errores?</p>
                        `,
                        options: [
                            "Descartar los datos que no coincidan con la hip√≥tesis",
                            "Repetir experimentos, registrar variables y analizar patrones", 
                            "Cambiar la hip√≥tesis para que coincida con los resultados",
                            "Atribuir las inconsistencias a errores aleatorios sin investigar"
                        ]
                    }
                ]
            }
        ];

        const FINAL_PHRASE = "LA ORGANIZACI√ìN Y EFICIENCIA EN LA CONVIVENCIA FOMENTAN LA INVESTIGACI√ìN E INNOVACI√ìN MEDIANTE LA EXPERIMENTACI√ìN";

        // =============================================
        // ESTADO DEL JUEGO
        // =============================================
        
        let gameState = {
            currentScreen: "welcome",
            currentSkill: null,
            currentChallengeIndex: 0,
            timeRemaining: 35 * 60,
            individualTimeRemaining: 0,
            timerInterval: null,
            individualTimerInterval: null,
            teamName: "",
            teamMembers: "",
            teamGrade: "",
            skillsProgress: {},
            startTime: null,
            stats: {
                correct: 0,
                incorrect: 0,
                skipped: 0
            },
            evaluationData: null,
            gameCompleted: false,
            gameEnded: false
        };

        // =============================================
        // INICIALIZACI√ìN
        // =============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupEventListeners();
        });

        function initializeGame() {
            // Inicializar el estado de las √°reas
            skillsData.forEach(skill => {
                if (!gameState.skillsProgress[skill.id]) {
                    gameState.skillsProgress[skill.id] = {
                        completed: false,
                        challengesCompleted: 0,
                        secretWordRevealed: false,
                        challenges: {}
                    };
                    
                    // Inicializar cada desaf√≠o
                    skill.challenges.forEach(challenge => {
                        gameState.skillsProgress[skill.id].challenges[challenge.id] = {
                            completed: false,
                            attempts: 0,
                            answer: null,
                            timeSpent: 0
                        };
                    });
                }
            });
            
            // Cargar estado guardado si existe
            loadGameState();
            
            // Inicializar la pantalla de √°reas
            updateSkillsScreen();
        }

        function setupEventListeners() {
            document.getElementById('begin-btn').addEventListener('click', startGame);
            document.getElementById('back-to-skills').addEventListener('click', () => showScreen('skills'));
            document.getElementById('force-completion').addEventListener('click', forceCompletion);
            document.getElementById('new-game-btn').addEventListener('click', resetGame);
            document.getElementById('continue-playing').addEventListener('click', continuePlaying);
            document.getElementById('download-report').addEventListener('click', downloadReport);
            document.getElementById('evaluation-form').addEventListener('submit', submitEvaluation);
            
            // Event listeners para pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            // Desactivar todas las pesta√±as y contenidos
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activar la pesta√±a seleccionada
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Si es la pesta√±a de logros o LEGO, generarlos
            if (tabId === 'achievements' || tabId === 'lego') {
                generateAchievementBars();
                generateLegoChart();
            }
            
            // Si es la pesta√±a de gr√°ficos, generarlos
            if (tabId === 'achievements') {
                generateCharts();
            }
        }

        // =============================================
        // FUNCIONES PRINCIPALES DEL JUEGO
        // =============================================
        
        function startGame() {
            const teamName = document.getElementById('team-name').value.trim();
            const teamMembers = document.getElementById('team-members').value.trim();
            const teamGrade = document.getElementById('team-grade').value.trim();
            
            if (!teamName || !teamMembers || !teamGrade) {
                alert('Por favor, completa todos los campos del equipo.');
                return;
            }
            
            gameState.teamName = teamName;
            gameState.teamMembers = teamMembers;
            gameState.teamGrade = teamGrade;
            gameState.startTime = new Date();
            gameState.gameCompleted = false;
            gameState.gameEnded = false;
            
            // Reiniciar estad√≠sticas
            gameState.stats = {
                correct: 0,
                incorrect: 0,
                skipped: 0
            };
            
            showScreen('skills');
            
            document.getElementById('display-team-name').textContent = gameState.teamName;
            document.getElementById('display-team-members').textContent = gameState.teamMembers;
            document.getElementById('display-team-grade').textContent = gameState.teamGrade;
            document.getElementById('challenge-team-name').textContent = gameState.teamName;
            document.getElementById('challenge-team-members').textContent = gameState.teamMembers;
            document.getElementById('challenge-team-grade').textContent = gameState.teamGrade;
            
            startTimer();
            saveGameState();
        }

        function startTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                
                const minutes = Math.floor(gameState.timeRemaining / 60);
                const seconds = gameState.timeRemaining % 60;
                
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('challenge-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (gameState.timeRemaining <= 300) {
                    document.getElementById('timer').style.color = '#e74c3c';
                    document.getElementById('challenge-timer').style.color = '#e74c3c';
                }
                
                if (gameState.timeRemaining <= 0) {
                    endGame();
                }
                
                // Guardar el estado cada 30 segundos
                if (gameState.timeRemaining % 30 === 0) {
                    saveGameState();
                }
            }, 1000);
        }

        function startIndividualTimer(minutes) {
            if (gameState.individualTimerInterval) {
                clearInterval(gameState.individualTimerInterval);
            }
            
            gameState.individualTimeRemaining = minutes * 60;
            document.getElementById('individual-timer').classList.remove('time-warning');
            
            gameState.individualTimerInterval = setInterval(() => {
                gameState.individualTimeRemaining--;
                
                const min = Math.floor(gameState.individualTimeRemaining / 60);
                const sec = gameState.individualTimeRemaining % 60;
                
                const timerElement = document.getElementById('individual-timer');
                timerElement.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                
                if (gameState.individualTimeRemaining <= 60) {
                    timerElement.classList.add('time-warning');
                }
                
                if (gameState.individualTimeRemaining <= 0) {
                    clearInterval(gameState.individualTimerInterval);
                    timerElement.textContent = "TIEMPO AGOTADO";
                    setTimeout(() => {
                        advanceToNextChallenge();
                    }, 2000);
                }
            }, 1000);
        }

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(`${screenName}-screen`).classList.add('active');
            gameState.currentScreen = screenName;
            
            if (screenName === 'skills') {
                updateSkillsScreen();
            } else if (screenName === 'completion') {
                updateCompletionScreen();
            }
        }

        function updateSkillsScreen() {
            const skillsContainer = document.getElementById('skills-container');
            skillsContainer.innerHTML = '';
            
            skillsData.forEach((skill, index) => {
                const skillProgress = gameState.skillsProgress[skill.id];
                const isUnlocked = index === 0 || 
                    (index > 0 && gameState.skillsProgress[skillsData[index-1].id].completed);
                
                const skillCard = document.createElement('div');
                skillCard.className = `skill-card ${isUnlocked ? '' : 'locked'} ${skillProgress.completed ? 'completed' : skillProgress.challengesCompleted > 0 ? 'incomplete' : ''}`;
                skillCard.id = `skill-${skill.id}`;
                
                let statusText = 'Disponible';
                if (skillProgress.completed) {
                    statusText = 'Completada';
                } else if (!isUnlocked) {
                    statusText = 'Bloqueada';
                } else if (skillProgress.challengesCompleted > 0) {
                    statusText = 'En progreso';
                }
                
                skillCard.innerHTML = `
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-header">
                        <h3>${skill.name}</h3>
                        <span class="skill-status ${skillProgress.completed ? 'completed' : skillProgress.challengesCompleted > 0 ? 'incomplete' : ''}">${statusText}</span>
                    </div>
                    <p>${skill.description}</p>
                    <p><strong>Desaf√≠os completados:</strong> ${skillProgress.challengesCompleted || 0}/3</p>
                    <p><strong>Palabra clave:</strong> ${skillProgress.secretWordRevealed ? skill.secretWord : '???'}</p>
                `;
                
                if (isUnlocked && !skillProgress.completed) {
                    skillCard.addEventListener('click', () => selectSkill(skill.id));
                } else if (skillProgress.completed) {
                    skillCard.addEventListener('click', () => {
                        alert(`¬°Ya completaste esta √°rea!\n\nPalabra clave: ${skill.secretWord}`);
                    });
                }
                
                skillsContainer.appendChild(skillCard);
            });
            
            updateProgressBar();
        }

        function updateProgressBar() {
            skillsData.forEach((skill, index) => {
                const progressItem = document.getElementById(`progress-${skill.id}`);
                const skillProgress = gameState.skillsProgress[skill.id];
                
                progressItem.className = 'progress-item';
                if (skillProgress.completed) {
                    progressItem.classList.add('completed');
                } else if (index === 0 || (index > 0 && gameState.skillsProgress[skillsData[index-1].id].completed)) {
                    progressItem.classList.add('active');
                } else if (skillProgress.challengesCompleted > 0) {
                    progressItem.classList.add('incomplete');
                }
            });
        }

        function selectSkill(skillId) {
            gameState.currentSkill = skillId;
            
            // Buscar el primer desaf√≠o no completado de esta √°rea
            const skill = skillsData.find(s => s.id === skillId);
            let firstIncomplete = 0;
            for (let i = 0; i < skill.challenges.length; i++) {
                const challenge = skill.challenges[i];
                if (!gameState.skillsProgress[skillId].challenges[challenge.id]?.completed) {
                    firstIncomplete = i;
                    break;
                }
            }
            
            gameState.currentChallengeIndex = firstIncomplete;
            showScreen('challenges');
            loadCurrentChallenge();
        }

        function loadCurrentChallenge() {
            const skill = skillsData.find(s => s.id === gameState.currentSkill);
            const challenge = skill.challenges[gameState.currentChallengeIndex];
            
            document.getElementById('current-skill-name').textContent = skill.name;
            document.getElementById('current-skill-description').textContent = skill.description;
            
            // Reiniciar el timer individual
            startIndividualTimer(challenge.timeLimit);
            
            updateChallengeProgressBar();
            
            const container = document.getElementById('challenges-container');
            container.innerHTML = '';
            
            const challengeElement = document.createElement('div');
            challengeElement.className = 'challenge-container';
            
            const challengeState = gameState.skillsProgress[skill.id].challenges[challenge.id];
            const attemptsRemaining = 2 - (challengeState?.attempts || 0);
            
            challengeElement.innerHTML = `
                <div class="challenge-header">
                    <h2 class="challenge-title">Desaf√≠o ${challenge.id}: ${challenge.title}</h2>
                    <span class="difficulty ${challenge.difficulty}">${getDifficultyText(challenge.difficulty)}</span>
                </div>
                <div class="challenge-content">
                    ${challenge.content}
                </div>
                <div class="options-container">
                    ${challenge.options.map((option, index) => {
                        const optionValue = String.fromCharCode(65 + index);
                        const isSelected = challengeState?.answer === optionValue;
                        return `
                            <div class="option ${isSelected ? 'selected' : ''}" data-value="${optionValue}">
                                <strong>${optionValue})</strong> ${option}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="attempts-counter" id="attempts-counter">
                    Intentos restantes: ${attemptsRemaining}
                </div>
                <div class="feedback" id="challenge-feedback"></div>
                <div class="secret-word-reveal" id="secret-word-reveal"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="submit-answer" ${attemptsRemaining <= 0 ? 'disabled' : ''}>Enviar Respuesta</button>
                    <button class="btn btn-warning" id="skip-challenge">Saltar Desaf√≠o</button>
                </div>
            `;
            
            container.appendChild(challengeElement);
            
            setupChallengeEvents();
        }

        function setupChallengeEvents() {
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('selected')) return;
                    
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
            
            document.getElementById('submit-answer').addEventListener('click', submitAnswer);
            document.getElementById('skip-challenge').addEventListener('click', skipChallenge);
        }

        function submitAnswer() {
            const skill = skillsData.find(s => s.id === gameState.currentSkill);
            const challenge = skill.challenges[gameState.currentChallengeIndex];
            const selectedOption = document.querySelector('.option.selected');
            
            if (!selectedOption) {
                alert('Por favor, selecciona una opci√≥n antes de enviar.');
                return;
            }
            
            const answer = selectedOption.getAttribute('data-value');
            const isCorrect = answer === challenge.correctAnswer;
            const challengeState = gameState.skillsProgress[skill.id].challenges[challenge.id];
            
            challengeState.attempts = (challengeState.attempts || 0) + 1;
            challengeState.answer = answer;
            challengeState.timeSpent = challenge.timeLimit * 60 - gameState.individualTimeRemaining;
            
            const attemptsRemaining = 2 - challengeState.attempts;
            document.getElementById('attempts-counter').textContent = 
                `Intentos restantes: ${attemptsRemaining}`;
            
            // Deshabilitar el bot√≥n de enviar si no quedan intentos
            if (attemptsRemaining <= 0) {
                document.getElementById('submit-answer').disabled = true;
            }
            
            const feedback = document.getElementById('challenge-feedback');
            
            if (isCorrect) {
                challengeState.completed = true;
                gameState.skillsProgress[skill.id].challengesCompleted = 
                    (gameState.skillsProgress[skill.id].challengesCompleted || 0) + 1;
                gameState.stats.correct++;
                
                feedback.textContent = '¬°Correcto! Has demostrado buena comprensi√≥n del problema.';
                feedback.className = 'feedback correct';
                
                clearInterval(gameState.individualTimerInterval);
                
                checkSkillCompletion(skill);
                
                setTimeout(() => {
                    advanceToNextChallenge();
                }, 2000);
            } else {
                gameState.stats.incorrect++;
                feedback.textContent = 'Respuesta incorrecta. Revisa el problema y considera un enfoque diferente.';
                feedback.className = 'feedback incorrect';
                
                // Si no quedan intentos, avanzar autom√°ticamente despu√©s de un tiempo
                if (attemptsRemaining <= 0) {
                    setTimeout(() => {
                        advanceToNextChallenge();
                    }, 2000);
                }
            }
            
            saveGameState();
        }

        function skipChallenge() {
            if (confirm("¬øEst√°s seguro de que quieres saltar este desaf√≠o? No contar√°s como completado.")) {
                const skill = skillsData.find(s => s.id === gameState.currentSkill);
                const challenge = skill.challenges[gameState.currentChallengeIndex];
                
                gameState.stats.skipped++;
                
                clearInterval(gameState.individualTimerInterval);
                
                advanceToNextChallenge();
                saveGameState();
            }
        }

        function advanceToNextChallenge() {
            const skill = skillsData.find(s => s.id === gameState.currentSkill);
            
            // Buscar el siguiente desaf√≠o no completado
            let nextChallengeIndex = -1;
            for (let i = gameState.currentChallengeIndex + 1; i < skill.challenges.length; i++) {
                const challenge = skill.challenges[i];
                if (!gameState.skillsProgress[skill.id].challenges[challenge.id]?.completed) {
                    nextChallengeIndex = i;
                    break;
                }
            }
            
            if (nextChallengeIndex !== -1) {
                gameState.currentChallengeIndex = nextChallengeIndex;
                loadCurrentChallenge();
            } else {
                // No hay m√°s desaf√≠os no completados en esta √°rea
                showScreen('skills');
                checkGameCompletion();
            }
            
            saveGameState();
        }

        function checkSkillCompletion(skill) {
            const skillProgress = gameState.skillsProgress[skill.id];
            const completedChallenges = Object.values(skillProgress.challenges).filter(c => c.completed).length;
            
            if (completedChallenges === skill.challenges.length) {
                skillProgress.completed = true;
                skillProgress.secretWordRevealed = true;
                
                const secretWordReveal = document.getElementById('secret-word-reveal');
                secretWordReveal.textContent = `¬°√Årea completada! Palabra clave: ${skill.secretWord}`;
                secretWordReveal.style.display = 'block';
                
                checkGameCompletion();
            }
            
            saveGameState();
        }

        function checkGameCompletion() {
            const allCompleted = skillsData.every(skill => 
                gameState.skillsProgress[skill.id].completed
            );
            
            if (allCompleted) {
                gameState.gameCompleted = true;
                setTimeout(() => {
                    endGame();
                }, 3000);
            }
            
            saveGameState();
        }

        function updateChallengeProgressBar() {
            for (let i = 1; i <= 3; i++) {
                const progressItem = document.getElementById(`progress-challenge-${i}`);
                progressItem.className = 'progress-item';
                
                const challengeIndex = i - 1;
                const skill = skillsData.find(s => s.id === gameState.currentSkill);
                const challenge = skill.challenges[challengeIndex];
                const challengeState = gameState.skillsProgress[skill.id].challenges[challenge.id];
                
                if (challengeIndex === gameState.currentChallengeIndex) {
                    progressItem.classList.add('active');
                } else if (challengeState?.completed) {
                    progressItem.classList.add('completed');
                } else if (challengeState?.attempts > 0) {
                    progressItem.classList.add('incomplete');
                }
            }
        }

        function getDifficultyText(difficulty) {
            switch(difficulty) {
                case 'facil': return 'F√°cil';
                case 'medio': return 'Medio';
                case 'dificil': return 'Dif√≠cil';
                default: return difficulty;
            }
        }

        function endGame() {
            clearInterval(gameState.timerInterval);
            if (gameState.individualTimerInterval) {
                clearInterval(gameState.individualTimerInterval);
            }
            
            gameState.gameEnded = true;
            showScreen('completion');
            saveGameState();
            
            // Guardar resultados finales
            saveFinalResults();
        }

        function forceCompletion() {
            if (confirm("¬øEst√°s seguro de que quieres finalizar ahora? Se guardar√° tu progreso actual y podr√°s ver el informe.")) {
                endGame();
            }
        }

        function continuePlaying() {
            if (gameState.timeRemaining > 0) {
                gameState.gameEnded = false;
                showScreen('skills');
                startTimer();
            } else {
                alert("No queda tiempo para continuar jugando.");
            }
        }

        function updateCompletionScreen() {
            document.getElementById('team-result-name').textContent = gameState.teamName;
            document.getElementById('team-members-result').textContent = gameState.teamMembers;
            document.getElementById('team-grade-result').textContent = gameState.teamGrade;
            
            // Actualizar estad√≠sticas
            document.getElementById('stat-correct').textContent = gameState.stats.correct;
            document.getElementById('stat-incorrect').textContent = gameState.stats.incorrect;
            
            const obtainedWords = skillsData.filter(skill => 
                gameState.skillsProgress[skill.id].secretWordRevealed
            ).length;
            document.getElementById('stat-words').textContent = obtainedWords;
            
            const timeUsed = 35 * 60 - gameState.timeRemaining;
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            document.getElementById('stat-time').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Mensaje luminoso final
            const obtainedWordsList = skillsData
                .filter(skill => gameState.skillsProgress[skill.id].secretWordRevealed)
                .map(skill => skill.secretWord);
            
            let finalMessage = "¬°Felicidades! Has completado el Escape Room.";
            if (obtainedWordsList.length === skillsData.length) {
                finalMessage = FINAL_PHRASE;
            } else if (obtainedWordsList.length > 0) {
                finalMessage = "Palabras obtenidas: " + obtainedWordsList.join(" ") + 
                    "\n\n¬°Buen trabajo! Has completado " + obtainedWordsList.length + " de " + skillsData.length + " √°reas.";
            } else {
                finalMessage = "¬°Intenta de nuevo! No has completado ninguna √°rea todav√≠a.";
            }
            
            document.getElementById('final-message').textContent = finalMessage;
            
            // Mostrar u ocultar el bot√≥n de continuar seg√∫n si queda tiempo
            if (gameState.timeRemaining <= 0 || gameState.gameCompleted) {
                document.getElementById('continue-playing').style.display = 'none';
            } else {
                document.getElementById('continue-playing').style.display = 'inline-block';
            }
            
            // Actualizar tabla de resultados
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            
            let totalCorrect = 0;
            let totalIncorrect = 0;
            
            skillsData.forEach(skill => {
                const skillProgress = gameState.skillsProgress[skill.id];
                const correct = skillProgress.challengesCompleted || 0;
                const incorrect = 3 - correct;
                
                totalCorrect += correct;
                totalIncorrect += incorrect;
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${skill.name}</td>
                    <td>${skillProgress.secretWordRevealed ? skill.secretWord : 'No obtenida'}</td>
                    <td>${correct}</td>
                    <td>${incorrect}</td>
                    <td>${skillProgress.completed ? '‚úÖ Completada' : skillProgress.challengesCompleted > 0 ? 'üü° En progreso' : '‚ùå No iniciada'}</td>
                `;
                
                resultsBody.appendChild(row);
            });
            
            // Agregar fila de totales
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            totalRow.innerHTML = `
                <td>TOTAL</td>
                <td></td>
                <td>${totalCorrect}</td>
                <td>${totalIncorrect}</td>
                <td>${obtainedWordsList.length}/${skillsData.length} palabras</td>
            `;
            resultsBody.appendChild(totalRow);
        }

        // =============================================
        // BARRAS DE LOGROS Y GR√ÅFICAS
        // =============================================
        
        function generateAchievementBars() {
            const container = document.getElementById('achievement-bars');
            container.innerHTML = '';
            
            skillsData.forEach(skill => {
                const skillProgress = gameState.skillsProgress[skill.id];
                const completed = skillProgress.challengesCompleted || 0;
                const total = skill.challenges.length;
                const percentage = (completed / total) * 100;
                
                const barElement = document.createElement('div');
                barElement.className = 'achievement-bar';
                barElement.innerHTML = `
                    <div class="achievement-label">
                        <span>${skill.name}</span>
                        <span>${completed}/${total} (${Math.round(percentage)}%)</span>
                    </div>
                    <div class="achievement-progress">
                        <div class="achievement-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                
                container.appendChild(barElement);
            });
        }
        
        function generateLegoChart() {
            const container = document.getElementById('lego-chart');
            container.innerHTML = '';
            
            let totalChallenges = 0;
            let completedChallenges = 0;
            
            skillsData.forEach(skill => {
                totalChallenges += skill.challenges.length;
                completedChallenges += gameState.skillsProgress[skill.id].challengesCompleted || 0;
            });
            
            // Crear bloques LEGO para cada desaf√≠o
            for (let i = 0; i < totalChallenges; i++) {
                const brick = document.createElement('div');
                brick.className = 'lego-brick';
                
                if (i < completedChallenges) {
                    brick.classList.add('completed');
                } else if (i === completedChallenges && !gameState.gameCompleted) {
                    brick.classList.add('current');
                } else {
                    brick.classList.add('incomplete');
                }
                
                container.appendChild(brick);
            }
        }

        function generateCharts() {
            // Datos para los gr√°ficos
            const skillNames = skillsData.map(skill => skill.name);
            const challengesCompleted = skillsData.map(skill => 
                gameState.skillsProgress[skill.id].challengesCompleted || 0
            );
            const challengesTotal = skillsData.map(skill => skill.challenges.length);
            
            const correctAnswers = gameState.stats.correct;
            const incorrectAnswers = gameState.stats.incorrect;
            const skippedChallenges = gameState.stats.skipped;
            
            // Gr√°fico de barras - Desaf√≠os por √°rea
            const skillsCtx = document.getElementById('skillsChart').getContext('2d');
            if (skillsCtx) {
                new Chart(skillsCtx, {
                    type: 'bar',
                    data: {
                        labels: skillNames,
                        datasets: [{
                            label: 'Desaf√≠os Completados',
                            data: challengesCompleted,
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        }, {
                            label: 'Total de Desaf√≠os',
                            data: challengesTotal,
                            backgroundColor: '#e74c3c',
                            borderColor: '#c0392b',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 3,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Desaf√≠os'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '√Åreas del Liceo'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de distribuci√≥n de resultados
            const resultsCtx = document.getElementById('resultsChart').getContext('2d');
            if (resultsCtx) {
                new Chart(resultsCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Correctas', 'Incorrectas', 'Omitidas'],
                        datasets: [{
                            data: [correctAnswers, incorrectAnswers, skippedChallenges],
                            backgroundColor: ['#27ae60', '#e74c3c', '#f39c12'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribuci√≥n de Respuestas'
                            }
                        }
                    }
                });
            }
        }

        // =============================================
        // GUARDADO Y CARGA DE ESTADO
        // =============================================
        
        function saveGameState() {
            try {
                const stateToSave = {
                    ...gameState,
                    timerInterval: null,
                    individualTimerInterval: null
                };
                localStorage.setItem('escapeRoomState', JSON.stringify(stateToSave));
            } catch (e) {
                console.error('Error guardando el estado del juego:', e);
            }
        }

        function loadGameState() {
            try {
                const savedState = localStorage.getItem('escapeRoomState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    // Verificar si el juego estaba en curso
                    if (parsedState.teamName && !parsedState.gameEnded) {
                        if (confirm('Tienes un juego en progreso. ¬øQuieres continuar donde lo dejaste?')) {
                            gameState = {
                                ...parsedState,
                                timerInterval: null,
                                individualTimerInterval: null
                            };
                            
                            // Actualizar la pantalla de bienvenida con los datos del equipo
                            document.getElementById('team-name').value = gameState.teamName;
                            document.getElementById('team-members').value = gameState.teamMembers;
                            document.getElementById('team-grade').value = gameState.teamGrade;
                            
                            // Si el juego estaba en curso, mostrar la pantalla de √°reas
                            if (gameState.currentScreen === 'skills' || gameState.currentScreen === 'challenges') {
                                showScreen('skills');
                                startTimer();
                            }
                        } else {
                            // Si no quiere continuar, limpiar el estado guardado
                            localStorage.removeItem('escapeRoomState');
                        }
                    }
                }
            } catch (e) {
                console.error('Error cargando el estado del juego:', e);
            }
        }

        function saveFinalResults() {
            try {
                const finalResults = {
                    teamName: gameState.teamName,
                    teamMembers: gameState.teamMembers,
                    teamGrade: gameState.teamGrade,
                    completionTime: new Date().toISOString(),
                    timeUsed: 35 * 60 - gameState.timeRemaining,
                    skills: skillsData.map(skill => {
                        const progress = gameState.skillsProgress[skill.id];
                        return {
                            skill: skill.name,
                            completed: progress.completed,
                            secretWord: progress.secretWordRevealed ? skill.secretWord : 'No obtenida',
                            challengesCompleted: progress.challengesCompleted || 0
                        };
                    }),
                    stats: gameState.stats
                };
                
                // Guardar en localStorage
                let allResults = JSON.parse(localStorage.getItem('escapeRoomResults') || '[]');
                allResults.push(finalResults);
                localStorage.setItem('escapeRoomResults', JSON.stringify(allResults));
                
            } catch (e) {
                console.error('Error guardando resultados finales:', e);
            }
        }

        function downloadReport() {
            const report = {
                equipo: gameState.teamName,
                integrantes: gameState.teamMembers,
                curso: gameState.teamGrade,
                fecha: new Date().toLocaleDateString('es-ES'),
                tiempoUtilizado: `${Math.floor((35 * 60 - gameState.timeRemaining) / 60)}:${((35 * 60 - gameState.timeRemaining) % 60).toString().padStart(2, '0')}`,
                areas: skillsData.map(skill => {
                    const progress = gameState.skillsProgress[skill.id];
                    return {
                        area: skill.name,
                        completada: progress.completed ? 'S√≠' : 'No',
                        palabraClave: progress.secretWordRevealed ? skill.secretWord : 'No obtenida',
                        desafiosCompletados: `${progress.challengesCompleted || 0}/3`
                    };
                }),
                estadisticas: {
                    aciertos: gameState.stats.correct,
                    fallos: gameState.stats.incorrect,
                    omitidos: gameState.stats.skipped
                }
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `informe_${gameState.teamName}_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // =============================================
        // EVALUACI√ìN
        // =============================================
        
        function submitEvaluation(e) {
            e.preventDefault();
            
            const formData = new FormData(document.getElementById('evaluation-form'));
            const evaluationData = {
                collaboration: formData.get('collaboration'),
                understanding: formData.get('understanding'),
                application: formData.get('application'),
                fun: formData.get('fun'),
                difficulty: formData.get('difficulty'),
                time_management: formData.get('time_management'),
                strengths: document.getElementById('strengths').value,
                improvements: document.getElementById('improvements').value,
                learnings: document.getElementById('learnings').value
            };
            
            alert('¬°Evaluaci√≥n enviada con √©xito! Gracias por participar.');
            
            // Aqu√≠ podr√≠as enviar los datos a Google Sheets
            // saveEvaluationToGoogleSheets(evaluationData);
        }

        // =============================================
        // REINICIAR JUEGO
        // =============================================
        
        function resetGame() {
            if (confirm("¬øEst√°s seguro de que quieres comenzar un nuevo juego? Se perder√° tu progreso actual.")) {
                gameState = {
                    currentScreen: "welcome",
                    currentSkill: null,
                    currentChallengeIndex: 0,
                    timeRemaining: 35 * 60,
                    individualTimeRemaining: 0,
                    timerInterval: null,
                    individualTimerInterval: null,
                    teamName: "",
                    teamMembers: "",
                    teamGrade: "",
                    skillsProgress: {},
                    startTime: null,
                    stats: {
                        correct: 0,
                        incorrect: 0,
                        skipped: 0
                    },
                    gameCompleted: false,
                    gameEnded: false
                };
                
                // Reinicializar √°reas
                skillsData.forEach(skill => {
                    gameState.skillsProgress[skill.id] = {
                        completed: false,
                        challengesCompleted: 0,
                        secretWordRevealed: false,
                        challenges: {}
                    };
                    
                    // Reinicializar cada desaf√≠o
                    skill.challenges.forEach(challenge => {
                        gameState.skillsProgress[skill.id].challenges[challenge.id] = {
                            completed: false,
                            attempts: 0,
                            answer: null,
                            timeSpent: 0
                        };
                    });
                });
                
                document.getElementById('timer').textContent = '35:00';
                document.getElementById('timer').style.color = '';
                document.getElementById('challenge-timer').textContent = '35:00';
                document.getElementById('challenge-timer').style.color = '';
                document.getElementById('individual-timer').textContent = '05:00';
                document.getElementById('individual-timer').className = '';
                
                // Limpiar formularios
                document.getElementById('team-name').value = '';
                document.getElementById('team-members').value = '';
                document.getElementById('team-grade').value = '';
                document.getElementById('evaluation-form').reset();
                
                showScreen('welcome');
                
                if (gameState.timerInterval) {
                    clearInterval(gameState.timerInterval);
                }
                if (gameState.individualTimerInterval) {
                    clearInterval(gameState.individualTimerInterval);
                }
                
                // Limpiar estado guardado
                localStorage.removeItem('escapeRoomState');
            }
        }
    </script>
</body>
</html>
